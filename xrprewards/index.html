<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reward Calculation System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    html {
      height: 100%;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    .toast.error {
      background: #ef4444;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
    }
    .editable-cell {
      cursor: text;
      padding: 8px;
      min-height: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .editable-cell:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    .editable-cell:focus {
      background: white;
      border-color: #3b82f6;
      outline: none;
    }
    .collection-tab {
      cursor: pointer;
      padding: 12px 24px;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
      white-space: nowrap;
    }
    .collection-tab:hover {
      background: #f3f4f6;
    }
    .collection-tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
    }
    .delete-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }
    tr:hover .delete-btn {
      opacity: 1;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
    }
    th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 10;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="min-h-full p-8">
   <div class="max-w-7xl mx-auto"><!-- Header -->
    <header class="bg-white rounded-2xl shadow-lg p-8 mb-6">
     <h1 class="text-4xl font-bold text-gray-800 mb-2">üéÅ Reward Calculation System</h1>
     <p class="text-gray-600">Customer Reward Management System</p>
    </header><!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Left Side: Main Content (2/3) -->
     <div class="lg:col-span-2 space-y-6"><!-- Collection Tabs -->
      <div class="bg-white rounded-2xl shadow-lg mb-6">
       <div class="flex border-b overflow-x-auto" id="collectionTabs">
        <div class="collection-tab active" data-collection="0"><span class="collection-name">Collection 1</span> <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="renameCollection(0)">‚úèÔ∏è</button>
        </div>
        <div class="collection-tab" data-collection="1"><span class="collection-name">Collection 2</span> <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="renameCollection(1)">‚úèÔ∏è</button>
        </div>
        <div class="collection-tab" data-collection="2"><span class="collection-name">Collection 3</span> <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="renameCollection(2)">‚úèÔ∏è</button>
        </div>
        <div class="collection-tab" data-collection="3"><span class="collection-name">Collection 4</span> <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="renameCollection(3)">‚úèÔ∏è</button>
        </div>
        <div class="collection-tab" data-collection="4"><span class="collection-name">Collection 5</span> <button class="ml-2 text-gray-400 hover:text-gray-600" onclick="renameCollection(4)">‚úèÔ∏è</button>
        </div>
       </div><!-- Controls -->
       <div class="p-6 space-y-4"><!-- Search and Add Owner -->
        <div class="flex gap-4 flex-wrap"><input type="text" id="searchInput" placeholder="üîç Search (Name or Address)" class="flex-1 min-w-[200px] px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <button onclick="showAddOwnerModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> ‚ûï Add Owner </button>
        </div><!-- Bulk Actions -->
        <div class="flex gap-4 flex-wrap"><button onclick="showBulkRateModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> üìä Bulk Rate Change </button> <button onclick="exportSimpleCSV()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> üíæ Simple CSV </button> <button onclick="exportFullBackup()" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> üì¶ Full Backup </button> <button onclick="showImportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> üì• Import CSV </button> <button onclick="showBulkDeleteModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md"> üóëÔ∏è Bulk Delete </button>
        </div>
       </div>
      </div><!-- Table -->
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
       <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
        <table class="w-full" id="ownerTable">
         <thead>
          <tr class="bg-gray-50 border-b-2 border-gray-200">
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Owner Name</th>
           <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Address</th>
           <th class="px-6 py-4 text-right text-sm font-semibold text-gray-700">Quantity</th>
           <th class="px-6 py-4 text-right text-sm font-semibold text-gray-700">Rate</th>
           <th class="px-6 py-4 text-right text-sm font-semibold text-gray-700">Reward</th>
           <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Actions</th>
          </tr>
         </thead>
         <tbody id="tableBody"><!-- Rows will be inserted here -->
         </tbody>
         <tfoot id="tableFoot" class="bg-gray-50 border-t-2 border-gray-200 font-bold">
          <tr>
           <td colspan="2" class="px-6 py-4 text-left text-gray-700">Total</td>
           <td class="px-6 py-4 text-right text-gray-700" id="totalQuantity">0</td>
           <td class="px-6 py-4 text-right text-gray-700">-</td>
           <td class="px-6 py-4 text-right text-blue-600" id="totalReward">0</td>
           <td></td>
          </tr>
         </tfoot>
        </table>
       </div>
      </div><!-- Footer Info -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
       <div class="flex justify-between items-center text-sm text-gray-600"><span id="recordCount">Total: 0 owners</span> <span>üíæ Data is automatically saved to browser</span>
       </div>
      </div>
     </div><!-- Right Side: Owner Consolidated View (1/3) -->
     <div class="lg:col-span-1">
      <div class="bg-white rounded-2xl shadow-lg p-6 sticky" style="top: 20px;">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">üë• Owner Consolidated View</h2><button onclick="exportConsolidatedCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm"> üíæ CSV </button>
       </div><!-- Search for consolidated view -->
       <div class="mb-4"><input type="text" id="consolidatedSearch" placeholder="üîç Search Owner" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
       </div><!-- Consolidated Owner List -->
       <div class="space-y-3" style="max-height: 600px; overflow-y: auto;" id="consolidatedOwnerList"><!-- Consolidated owner cards will be inserted here -->
       </div><!-- Total Summary -->
       <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex justify-between items-center text-sm mb-2"><span class="text-gray-600">Unique Owners</span> <span class="font-bold text-gray-800" id="uniqueOwnerCount">0</span>
        </div>
        <div class="flex justify-between items-center text-sm"><span class="text-gray-600">Grand Total Reward</span> <span class="font-bold text-blue-600" id="grandTotalReward">0</span>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // LocalStorage key
    const STORAGE_KEY = 'rewardCalculationData';
    
    // State
    let owners = [];
    let collections = [
      { name: 'Collection 1' },
      { name: 'Collection 2' },
      { name: 'Collection 3' },
      { name: 'Collection 4' },
      { name: 'Collection 5' }
    ];
    let activeCollection = 0;
    let searchQuery = '';

    // Initialize
    function init() {
      loadFromLocalStorage();
      setupEventListeners();
      render();
    }

    // LocalStorage operations
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          owners = data.owners || [];
          collections = data.collections || collections;
          activeCollection = data.activeCollection || 0;
        }
      } catch (e) {
        console.error('Failed to load data:', e);
        showToast('Failed to load data', true);
      }
    }

    function saveToLocalStorage() {
      try {
        const data = {
          owners,
          collections,
          activeCollection,
          lastUpdated: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save data:', e);
        showToast('Failed to save data', true);
      }
    }

    // Event listeners
    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', (e) => {
        searchQuery = e.target.value.toLowerCase();
        render();
      });

      document.querySelectorAll('.collection-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          const collection = parseInt(tab.dataset.collection);
          activeCollection = collection;
          saveToLocalStorage();
          updateActiveTab();
          render();
        });
      });
    }

    function updateActiveTab() {
      document.querySelectorAll('.collection-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-collection="${activeCollection}"]`).classList.add('active');
    }

    // Render
    function render() {
      const tbody = document.getElementById('tableBody');
      const filtered = getFilteredOwners();
      
      tbody.innerHTML = '';
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
              ${searchQuery ? 'No search results found' : 'Please add owners'}
            </td>
          </tr>
        `;
      } else {
        filtered.forEach(owner => {
          const row = createOwnerRow(owner);
          tbody.appendChild(row);
        });
      }

      updateSummary(filtered);
      updateRecordCount();
      updateCollectionNames();
      updateGlobalSummary();
    }

    function getFilteredOwners() {
      let filtered = owners.filter(o => o.collection === activeCollection);
      
      if (searchQuery) {
        filtered = filtered.filter(o => 
          o.name.toLowerCase().includes(searchQuery) ||
          o.address.toLowerCase().includes(searchQuery)
        );
      }
      
      return filtered;
    }

    function createOwnerRow(owner) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors';
      tr.dataset.ownerId = owner.id;
      
      const reward = owner.quantity * owner.rate;
      
      tr.innerHTML = `
        <td class="px-6 py-4">
          <div class="editable-cell" contenteditable="true" data-field="name">${escapeHtml(owner.name)}</div>
        </td>
        <td class="px-6 py-4">
          <div class="font-mono text-sm text-gray-700 px-2 py-1">${escapeHtml(owner.address)}</div>
        </td>
        <td class="px-6 py-4 text-right">
          <div class="editable-cell" contenteditable="true" data-field="quantity">${owner.quantity}</div>
        </td>
        <td class="px-6 py-4 text-right">
          <div class="editable-cell" contenteditable="true" data-field="rate">${owner.rate}</div>
        </td>
        <td class="px-6 py-4 text-right font-semibold text-blue-600">${reward.toLocaleString()}</td>
        <td class="px-6 py-4 text-center">
          <button class="delete-btn text-red-600 hover:text-red-800 font-semibold px-3 py-1 rounded transition-colors" onclick="deleteOwner('${owner.id}')">
            üóëÔ∏è
          </button>
        </td>
      `;

      // Add blur event listeners for inline editing
      tr.querySelectorAll('.editable-cell').forEach(cell => {
        cell.addEventListener('blur', (e) => {
          const field = cell.dataset.field;
          const value = cell.textContent.trim();
          updateOwnerField(owner.id, field, value);
        });

        cell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            cell.blur();
          }
        });
      });

      return tr;
    }

    function updateOwnerField(ownerId, field, value) {
      const owner = owners.find(o => o.id === ownerId);
      if (!owner) return;

      if (field === 'quantity' || field === 'rate') {
        const num = parseFloat(value);
        if (isNaN(num) || num < 0) {
          showToast('Invalid number', true);
          render();
          return;
        }
        owner[field] = num;
      } else {
        owner[field] = value;
      }

      saveToLocalStorage();
      render();
      showToast('Updated');
    }

    function updateSummary(filtered) {
      const totalQuantity = filtered.reduce((sum, o) => sum + o.quantity, 0);
      const totalReward = filtered.reduce((sum, o) => sum + (o.quantity * o.rate), 0);

      document.getElementById('totalQuantity').textContent = totalQuantity.toLocaleString();
      document.getElementById('totalReward').textContent = totalReward.toLocaleString();
    }

    function updateRecordCount() {
      const collectionOwners = owners.filter(o => o.collection === activeCollection);
      document.getElementById('recordCount').textContent = 
        `Total: ${collectionOwners.length} owners (Overall: ${owners.length})`;
    }

    function updateCollectionNames() {
      document.querySelectorAll('.collection-name').forEach((span, idx) => {
        span.textContent = collections[idx].name;
      });
    }

    let consolidatedSearchQuery = '';

    function updateGlobalSummary() {
      // Get consolidated owner data (grouped by name)
      const consolidatedData = getConsolidatedOwnerData();
      
      // Filter by search query
      let filtered = consolidatedData;
      if (consolidatedSearchQuery) {
        filtered = consolidatedData.filter(owner => 
          owner.name.toLowerCase().includes(consolidatedSearchQuery) ||
          owner.address.toLowerCase().includes(consolidatedSearchQuery)
        );
      }

      // Update grand total
      const grandTotal = consolidatedData.reduce((sum, owner) => sum + owner.totalReward, 0);
      document.getElementById('grandTotalReward').textContent = grandTotal.toLocaleString();

      // Update unique owner count
      document.getElementById('uniqueOwnerCount').textContent = consolidatedData.length.toLocaleString();

      // Update consolidated owner list
      const listContainer = document.getElementById('consolidatedOwnerList');
      listContainer.innerHTML = '';

      if (filtered.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center text-gray-500 text-sm py-8">
            ${consolidatedSearchQuery ? 'No search results found' : 'No owners yet'}
          </div>
        `;
        return;
      }

      filtered.forEach(owner => {
        const card = document.createElement('div');
        card.className = 'border-b border-gray-200 py-2 hover:bg-gray-50 transition-all px-2';
        
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-sm text-gray-800 truncate">${escapeHtml(owner.name)}</div>
              <div class="font-mono text-xs text-gray-400 truncate">${escapeHtml(owner.address)}</div>
            </div>
            <div class="text-right ml-3">
              <div class="text-sm font-bold text-blue-600">${owner.totalReward.toLocaleString()}</div>
            </div>
          </div>
        `;
        
        listContainer.appendChild(card);
      });

      // Setup search listener (only once)
      if (!window.consolidatedSearchSetup) {
        document.getElementById('consolidatedSearch').addEventListener('input', (e) => {
          consolidatedSearchQuery = e.target.value.toLowerCase();
          updateGlobalSummary();
        });
        window.consolidatedSearchSetup = true;
      }
    }

    function getConsolidatedOwnerData() {
      // Group owners by name (case-insensitive)
      const ownerMap = new Map();

      owners.forEach(owner => {
        const key = owner.name.toLowerCase();
        
        if (!ownerMap.has(key)) {
          ownerMap.set(key, {
            name: owner.name,
            address: owner.address,
            addresses: new Set(),
            collections: [],
            totalReward: 0
          });
        }

        const consolidated = ownerMap.get(key);
        const reward = owner.quantity * owner.rate;
        
        // Add address to the set
        consolidated.addresses.add(owner.address);
        
        // Find if this collection already exists for this owner
        const existingCol = consolidated.collections.find(c => c.collectionIndex === owner.collection);
        
        if (existingCol) {
          // Add to existing collection entry
          existingCol.quantity += owner.quantity;
          existingCol.reward += reward;
        } else {
          // Create new collection entry
          consolidated.collections.push({
            collectionIndex: owner.collection,
            collectionName: collections[owner.collection].name,
            quantity: owner.quantity,
            rate: owner.rate,
            reward: reward
          });
        }
        
        consolidated.totalReward += reward;
      });

      // Convert map to array, format addresses, and sort by total reward (descending)
      return Array.from(ownerMap.values()).map(owner => ({
        ...owner,
        address: owner.addresses.size > 1 
          ? `${owner.addresses.size} addresses` 
          : owner.address,
        addressCount: owner.addresses.size
      })).sort((a, b) => b.totalReward - a.totalReward);
    }

    function exportConsolidatedCSV() {
      const consolidatedData = getConsolidatedOwnerData();
      
      if (consolidatedData.length === 0) {
        showToast('No data to export', true);
        return;
      }

      // Create CSV with owner, address, and all collection rewards
      const headers = ['Owner Name', 'Address', ...collections.map(c => c.name), 'Total Reward'];
      
      const rows = consolidatedData.map(owner => {
        const row = [owner.name, owner.address];
        
        // Add reward for each collection (0 if not present)
        collections.forEach((col, idx) => {
          const colData = owner.collections.find(c => c.collectionIndex === idx);
          row.push(colData ? colData.reward : 0);
        });
        
        // Add total
        row.push(owner.totalReward);
        
        return row;
      });

      const csv = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      downloadCSV(csv, `rewards_consolidated_${new Date().toISOString().split('T')[0]}.csv`);
      showToast('Consolidated CSV exported');
    }

    // Add Owner Modal
    function showAddOwnerModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">‚ûï Add Owner</h2>
          <p class="text-sm text-gray-600 mb-4">* At least one of Owner Name or Address is required</p>
          <form id="addOwnerForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Owner Name</label>
              <input type="text" id="ownerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
              <input type="text" id="ownerAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
              <input type="number" id="ownerQuantity" required min="0" step="0.01" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Rate *</label>
              <input type="number" id="ownerRate" required min="0" step="0.01" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                Add
              </button>
              <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;

      modal.querySelector('form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (owners.length >= 999) {
          showToast('Maximum 999 owners allowed', true);
          return;
        }

        const nameValue = document.getElementById('ownerName').value.trim();
        const addressValue = document.getElementById('ownerAddress').value.trim();

        // At least one of name or address must be filled
        if (!nameValue && !addressValue) {
          showToast('Please enter either Owner Name or Address', true);
          return;
        }

        const newOwner = {
          id: 'owner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name: nameValue || '-',
          address: addressValue || '-',
          quantity: parseFloat(document.getElementById('ownerQuantity').value),
          rate: parseFloat(document.getElementById('ownerRate').value),
          collection: activeCollection
        };

        owners.push(newOwner);
        saveToLocalStorage();
        render();
        modal.remove();
        showToast('Owner added');
      });

      document.body.appendChild(modal);
      document.getElementById('ownerName').focus();
    }

    // Delete Owner
    function deleteOwner(ownerId) {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-4 text-gray-800">üóëÔ∏è Delete Confirmation</h2>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this owner?</p>
          <div class="flex gap-3">
            <button onclick="confirmDelete('${ownerId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
              Delete
            </button>
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmDelete(ownerId) {
      owners = owners.filter(o => o.id !== ownerId);
      saveToLocalStorage();
      render();
      document.querySelector('.modal-backdrop').remove();
      showToast('Deleted');
    }

    // Bulk Rate Change
    function showBulkRateModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">üìä Bulk Rate Change</h2>
          <p class="text-gray-600 mb-4">Change rate for all owners in current collection</p>
          <form id="bulkRateForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">New Rate *</label>
              <input type="number" id="newRate" required min="0" step="0.01" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                Change
              </button>
              <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;

      modal.querySelector('form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newRate = parseFloat(document.getElementById('newRate').value);
        
        let count = 0;
        owners.forEach(owner => {
          if (owner.collection === activeCollection) {
            owner.rate = newRate;
            count++;
          }
        });

        saveToLocalStorage();
        render();
        modal.remove();
        showToast(`Rate changed for ${count} owners`);
      });

      document.body.appendChild(modal);
      document.getElementById('newRate').focus();
    }

    // Bulk Delete
    function showBulkDeleteModal() {
      const collectionOwners = owners.filter(o => o.collection === activeCollection);
      
      if (collectionOwners.length === 0) {
        showToast('No owners to delete', true);
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-4 text-red-600">‚ö†Ô∏è Bulk Delete Confirmation</h2>
          <p class="text-gray-600 mb-6">Are you sure you want to delete <strong>all ${collectionOwners.length} owners</strong> in this collection?<br>This action cannot be undone.</p>
          <div class="flex gap-3">
            <button onclick="confirmBulkDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
              Delete All
            </button>
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmBulkDelete() {
      const count = owners.filter(o => o.collection === activeCollection).length;
      owners = owners.filter(o => o.collection !== activeCollection);
      saveToLocalStorage();
      render();
      document.querySelector('.modal-backdrop').remove();
      showToast(`Deleted ${count} owners`);
    }

    // Rename Collection
    function renameCollection(collectionIdx) {
      const currentName = collections[collectionIdx].name;
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">‚úèÔ∏è Rename Collection</h2>
          <form id="renameForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">New Name *</label>
              <input type="text" id="newCollectionName" required value="${escapeHtml(currentName)}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                Change
              </button>
              <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;

      modal.querySelector('form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newName = document.getElementById('newCollectionName').value.trim();
        collections[collectionIdx].name = newName;
        saveToLocalStorage();
        render();
        modal.remove();
        showToast('Collection renamed');
      });

      document.body.appendChild(modal);
      document.getElementById('newCollectionName').select();
    }

    // CSV Export - Simple
    function exportSimpleCSV() {
      const collectionOwners = owners.filter(o => o.collection === activeCollection);
      
      if (collectionOwners.length === 0) {
        showToast('No data to export', true);
        return;
      }

      const headers = ['Owner Name', 'Address', 'Quantity', 'Rate', 'Reward'];
      const rows = collectionOwners.map(o => [
        o.name,
        o.address,
        o.quantity,
        o.rate,
        o.quantity * o.rate
      ]);

      const csv = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      downloadCSV(csv, `rewards_${collections[activeCollection].name}_${new Date().toISOString().split('T')[0]}.csv`);
      showToast('Simple CSV exported');
    }

    // CSV Export - Full Backup
    function exportFullBackup() {
      if (owners.length === 0) {
        showToast('No data to export', true);
        return;
      }

      const headers = ['Owner Name', 'Address', 'Quantity', 'Rate', 'Collection', 'ID'];
      const rows = owners.map(o => [
        o.name,
        o.address,
        o.quantity,
        o.rate,
        o.collection,
        o.id
      ]);

      const csv = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      downloadCSV(csv, `rewards_full_backup_${new Date().toISOString().split('T')[0]}.csv`);
      showToast('Full Backup exported');
    }

    function downloadCSV(csvContent, filename) {
      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // CSV Import
    function showImportModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">üì• Import CSV</h2>
          
          <div class="text-sm mb-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
            <strong class="text-gray-800 block mb-2">üìã Required CSV Format (in this order):</strong>
            <ol class="ml-5 list-decimal text-gray-700 space-y-1">
              <li><strong>Owner Name</strong></li>
              <li><strong>Address</strong></li>
              <li><strong>Quantity</strong></li>
              <li><strong>Rate</strong></li>
              <li><strong>Collection</strong> (0-4: 0=Collection1, 1=Collection2, etc.)</li>
              <li><strong>ID</strong> (optional - auto-generated if missing)</li>
            </ol>
          </div>

          <div class="bg-red-50 p-3 rounded-lg border border-red-200 mb-4">
            <p class="text-red-700 font-semibold text-sm">‚ö†Ô∏è Warning: Existing data will be completely overwritten!</p>
          </div>

          <form id="importForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">CSV File *</label>
              <input type="file" id="csvFile" accept=".csv" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                Import
              </button>
              <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;

      modal.querySelector('form').addEventListener('submit', (e) => {
        e.preventDefault();
        const file = document.getElementById('csvFile').files[0];
        
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = parseCSVLine(lines[0]);
            
            const importedOwners = [];
            for (let i = 1; i < lines.length; i++) {
              const values = parseCSVLine(lines[i]);
              if (values.length < 5) continue;
              
              importedOwners.push({
                name: values[0],
                address: values[1],
                quantity: parseFloat(values[2]) || 0,
                rate: parseFloat(values[3]) || 0,
                collection: parseInt(values[4]) || 0,
                id: values[5] || ('owner_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9))
              });
            }

            owners = importedOwners;
            saveToLocalStorage();
            render();
            modal.remove();
            showToast(`Imported ${importedOwners.length} records`);
          } catch (err) {
            showToast('Failed to read CSV', true);
          }
        };
        reader.readAsText(file);
      });

      document.body.appendChild(modal);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      
      return result;
    }

    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Utility
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on load
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a354f1a0388a0ee',t:'MTc2Mzk0OTU4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>